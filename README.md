# Functional-Group Atlas for Interface Programming (FGA)

[![Python](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Status](https://img.shields.io/badge/status-active-brightgreen.svg)]()

A compact, publication-grade machine-learning workflow to construct a **data-driven functional-group atlas** for **carbonâ€“molten salt interfacial design**, enabling predictable tuning of:

- **Interfacial wettability** â†’ target: **Eb**
- **Interfacial heat-transport potential** â†’ target: **NVOA**

The workflow is implemented in two Jupyter notebooks:
1) hierarchical **feature engineering**  
2) **Bayesian optimization â†’ stacking ensemble â†’ robustness evaluation â†’ SHAP interpretation â†’ prediction**

---

## Whatâ€™s inside

- **Script A â€” Feature Engineering** (`Feature engineering-FGA.ipynb`)  
  A three-stage selection strategy: **Filter (Pearson) â†’ Embedded (RF-SHAP) â†’ Wrapper (SHAP-guided elimination with early stopping)**.

- **Script B â€” Stacking & Prediction** (`Tree_stacking-FGA.ipynb`)  
  - Bayesian hyperparameter optimization for multiple tree regressors  
  - OOF stacking with **ElasticNet** meta-learner  
  - Robustness evaluation via repeated outer CV (multi-seed)  
  - **Two-Level Weighted SHAP** global importance export  
  - One-click prediction for unseen candidates

---

## Repository layout (minimal)
.
â”œâ”€â”€ Feature engineering-FGA.ipynb
â”œâ”€â”€ Tree_stacking-FGA.ipynb
â”œâ”€â”€ Original database-FGA.xlsx # user-provided raw database (features + Eb + NVOA)
â”œâ”€â”€ prediction-FGA-Eb.xlsx # user-provided prediction set (features only)
â”œâ”€â”€ prediction-FGA-NVOA.xlsx # user-provided prediction set (features only)
â”œâ”€â”€ feature_engineering_output/ # auto-generated by Script A
â”œâ”€â”€ SHAP_Analysis_Results.xlsx # auto-generated by Script B
â”œâ”€â”€ unknown_predictions_*.xlsx # auto-generated prediction outputs
â”œâ”€â”€ environment.yml / requirements.txt / spec-file.txt
â”œâ”€â”€ manuscript-functional group atlas.pdf # optional (paper)
â”œâ”€â”€ SI-functional group atlas.pdf # optional (supporting info)
â””â”€â”€ LICENSE

---

## Data contract (Excel)

### 1) Raw database: `Original database-FGA.xlsx`
**Default assumption in Script A**
- **Column 0**: ID / name (optional but recommended)
- **Columns 1 : -2**: feature descriptors (numeric)
- **Last two columns**: targets (**Eb** and **NVOA**, order can be selected by index)

You control which target is used via:
- `TARGET_COLUMN_INDEX = -1` (last column)
- `TARGET_COLUMN_INDEX = -2` (second-to-last column)

### 2) Prediction files: `prediction-FGA-*.xlsx`
- **Column 0**: ID / name
- **Columns 1..end**: features (numeric)
- Feature names should match training features whenever possible. The notebook includes column alignment logic; still, consistent naming is strongly recommended.

---

## Quickstart

### 0) Environment
Use **one** of the provided configs:

```bash
# Option A (simple)
pip install -r requirements.txt

# Option B (conda, recommended)
conda env create -f environment.yml -n fga
conda activate fga

```
## Step 1 â€” Feature engineering (run twice)

Open: `Feature engineering-FGA.ipynb`

**Default key settings**
- `INPUT_FILE = 'Original database-FGA.xlsx'`
- `FEATURE_COLUMN_SLICE = '1:-2'`
- `TARGET_COLUMN_INDEX = -1`  (switch to `-2` for the other target)
- `PEARSON_CORR_THRESHOLD = 0.8`
- `FILTER_METHOD_CRITERION = 'mutual_info'`
- `SHAP_COARSE_SELECTION_PERCENT = 0.8`
- `EARLY_STOPPING_PATIENCE = 50`
- `KFOLD_SPLITS = 10`

**Run A for NVOA**
1. set `TARGET_COLUMN_INDEX = -1` (or whichever column corresponds to NVOA)
2. Run all cells  
3. Output (timestamped):  
   `feature_engineering_output/Final_Selected_Dataset_YYYYMMDD_HHMMSS.xlsx`  
4. Rename (recommended):  
   `Final_engineered_dataset-FGA-NVOA.xlsx`

**Run A for Eb**
1. set `TARGET_COLUMN_INDEX = -2` (or whichever column corresponds to Eb)
2. Run all cells  
3. Rename output to:  
   `Final_engineered_dataset-FGA-Eb.xlsx`

---

## Step 2 â€” Training + evaluation + SHAP (run twice)

Open: `Tree_stacking-FGA.ipynb` and run **top â†’ bottom**.

### Part B-1: Bayesian hyperparameter tuning
Set:
- `EXCEL_FILE_PATH = 'Final_engineered_dataset-FGA-Eb.xlsx'`  
  (or `Final_engineered_dataset-FGA-NVOA.xlsx`)
- `X_COLS_SLICE = slice(1, -1)`
- `Y_COLS_SLICE = -1`
- `CV_N_SPLITS = 10`
- `N_ITER_BAYESIAN = 30`
- `ENABLED_MODELS = [...]`

### Part B-2: Stacking, robustness, Two-Level Weighted SHAP
Key settings:
- `N_SEEDS_FOR_EVALUATION = 100`
- `N_SPLITS_OUTER_CV = 10`
- `META_LEARNER_N_ITER_BAYESIAN = 50`
- `OUTPUT_EXCEL_FILENAME = 'SHAP_Analysis_Results.xlsx'`
- `WEIGHTING_METHOD = '1/RMSE'`
- `PLOT_SHAP_SWARM_PLOT = True`
- `SHAP_SWARM_SAMPLES_LIMIT = 5000`

Outputs:
- `SHAP_Analysis_Results.xlsx` (multi-sheet report: metrics + global importances + swarm data)

**Practical note (speed vs. fidelity):**
- For a fast sanity check, set `N_SEEDS_FOR_EVALUATION = 5â€“10`.
- SHAP beeswarm can be memory-intensive; keep `SHAP_SWARM_SAMPLES_LIMIT` and/or disable `PLOT_SHAP_SWARM_PLOT`.

---

## Step 3 â€” Prediction on unseen candidates (run twice)

In the same notebook (Part B-3), set:
- `UNKNOWN_DATA_FILE = 'prediction-FGA-Eb.xlsx'`  
  (or `prediction-FGA-NVOA.xlsx`)
- `UNKNOWN_DATA_FILE_COLUMN_RANGE = (slice(None), slice(1, None))`  (skip ID column)
- `REUSE_PRETRAINED_STACKING_MODEL = False` *(default: retrain in prediction mode)*

Outputs:
- `unknown_predictions_YYYYMMDD_HHMMSS.xlsx`  
  Includes the final stacking prediction and individual base-learner predictions.

---

## Reproducibility checklist

- Keep `DEFAULT_MODEL_RANDOM_STATE` consistent across scripts.
- Run **B-1 â†’ B-2 â†’ B-3** in one session if you plan to reuse trained objects.
- Record:
  - notebook commit hash
  - environment file used (`environment.yml` / `spec-file.txt`)
  - `N_SEEDS_FOR_EVALUATION`, CV folds, and enabled model list

---

## License & correspondence

Released under the **MIT License** (see `LICENSE`).

For correspondence:  
Prof. **Guangmin Zhou** (Tsinghua Shenzhen International Graduate School, Tsinghua University)  
ðŸ“§ guangminzhou@sz.tsinghua.edu.cn

---

## Citation (optional)

```bibtex
@article{zhu_functional_group_atlas,
  title   = {A data-driven functional-group atlas for programming interfacial wettability and heat transport for thermal energy storage},
  author  = {Zhu, Yifei and Wang, Tiansheng and Zhou, Guangmin},
  journal = {Manuscript under review},
  year    = {2026}
}


